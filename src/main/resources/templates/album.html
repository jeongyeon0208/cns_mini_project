<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>앨범 상세</title>
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <style>
    .deleted-song {
      opacity: 0.5;
    }

    #songEditForm {
      display: none;
    }
  </style>
</head>
<body>

<a href="/" class="home-button">홈으로</a>
<h2>앨범 상세 정보</h2>
<table>
    <tr>
      <th>앨범 ID</th>
      <td th:text="${album.albumId}"></td>
  <tr>
    <th>앨범명</th>
    <td th:text="${album.albumName}"></td>
  </tr>
  <tr>
    <th>대표곡</th>
    <td th:text="${album.titleSong}"></td>
  </tr>
  <tr>
    <th>발매날짜</th>
    <td th:text="${album.releaseDate}"></td>
  </tr>
  <tr>
    <th>장르</th>
    <td th:text="${album.genre}"></td>
  </tr>
  <tr>
    <th>아티스트</th>
    <td th:text="${album.artist}"></td>
  </tr>
</table>

<!-- 앨범 수정과 앨범 삭제는 나란히 보여주기 -->
<div style="display: flex; gap: 20px;">
  <button id="editButton" onclick="toggleEditForm()">앨범 수정하기</button>
  <button id="deleteButton" onclick="confirmDelete()">앨범 삭제하기</button>
</div>

<!-- 앨범 수정 폼, initially hidden -->
<div id="editForm" style="display: none;">
  <form th:action="@{/album/update/{albumId}(albumId=${album.albumId})}" method="POST">
    <label for="albumName">앨범명:</label>
    <input type="text" id="albumName" name="albumName" th:value="${album.albumName}" required /><br>
    <label for="titleSong">대표곡:</label>
    <input type="text" id="titleSong" name="titleSong" th:value="${album.titleSong}" required /><br>
    <label for="releaseDate">발매날짜:</label>
    <input type="text" id="releaseDate" name="releaseDate" th:value="${album.releaseDate}" required /><br>
    <label for="genre">장르:</label>
    <input type="text" id="genre" name="genre" th:value="${album.genre}" required /><br>
    <label for="artist">아티스트:</label>
    <input type="text" id="artist" name="artist" th:value="${album.artist}" required /><br>
    <button type="submit">수정 완료</button>
    <button type="button" onclick="toggleEditForm()">수정 취소</button>
  </form>
</div>

<h3>수록곡</h3>
<table>
  <thead>
  <tr>
    <th>트랙 번호</th>
    <th>곡명</th>
    <th>길이</th>
    <th>상세보기</th>
  </tr>
  </thead>
  <tbody>
  <tr th:each="song : ${album.songList}">
    <td th:text="${song.songTrackNumber}"></td>
    <td th:text="${song.songName}"></td>
    <td th:text="${song.songLength}"></td>
    <td><a th:href="@{/song/{id}(id=${song.songId})}">보기</a></td>
  </tr>
  </tbody>
</table>

<button id="songEditButton" onclick="toggleSongEditForm()">수록곡 추가</button>

<!-- 수록곡 추가 폼 -->
<div id="songEditForm" style="display: none;">
  <h4>새 수록곡 추가</h4>
  <form id="newSongForm" method="POST" action="/song">
    <input type="number" name="songAlbumId" th:value="${album.albumId}" readonly />
    <div id="newSongsList">
      <table>
        <thead>
        <tr>
          <th>트랙 번호</th>
          <th>곡명</th>
          <th>길이</th>
          <th>가사</th>
          <th>장르</th>
          <th>아티스트</th>
          <th>삭제</th>
        </tr>
        </thead>
        <tbody>
        <!-- 추가된 수록곡은 여기에 표시됩니다 -->
        </tbody>
      </table>
    </div>
    <button type="button" onclick="addNewSong()">+ 수록곡 추가</button><br>
    <button type="submit">수록곡 추가 완료</button>
    <button type="button" onclick="cancelSongEdit()">수록곡 추가 취소</button>
  </form>
</div>

<a href="/album">앨범 목록으로</a>

<!-- JavaScript to toggle edit form visibility -->
<script>
  var deletedSongs = [];  // 삭제된 곡을 추적하는 배열

  function toggleEditForm() {
    var editForm = document.getElementById("editForm");
    var editButton = document.getElementById("editButton");
    if (editForm.style.display === "none") {
      editForm.style.display = "block";
      editButton.style.display = "none";
    } else {
      editForm.style.display = "none";
      editButton.style.display = "inline-block";
    }
  }

  function confirmDelete() {
    var isConfirmed = confirm("정말로 삭제하시겠습니까?");
    if (isConfirmed) {
      var form = document.createElement('form');
      form.method = 'POST';
      form.action = '/album/delete/' + [[${album.albumId}]];

      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = '_method';
      input.value = 'DELETE';

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    }
  }

  function toggleSongEditForm() {
    var songEditForm = document.getElementById("songEditForm");
    if (songEditForm.style.display === "none") {
      songEditForm.style.display = "block";
    } else {
      songEditForm.style.display = "none";
    }
  }

  function cancelSongEdit() {
    // 추가된 수록곡을 모두 삭제하거나 폼을 초기 상태로 되돌립니다.
    document.querySelector('#newSongsList tbody').innerHTML = '';
    document.getElementById('songEditForm').style.display = 'none'; // 수록곡 수정 폼 숨기기
  }

  function addNewSong() {
    var newSongRow = `
      <tr>
        <td><input type="number" name="songTrackNumber" required /></td>
        <td><input type="text" name="songName" required /></td>
        <td><input type="text" name="songLength" required /></td>
        <td><textarea name="songLyrics" required></textarea></td>
        <td><input type="text" name="songGenre" required /></td>
        <td><input type="text" name="artist" required /></td>
        <td><button type="button" onclick="removeNewSong(this)">삭제</button></td>
      </tr>
    `;
    document.querySelector('#newSongsList tbody').insertAdjacentHTML('beforeend', newSongRow);
  }

  function removeNewSong(button) {
    button.closest('tr').remove();
  }

  function deleteSelectedSongs() {
    var selectedSongs = document.querySelectorAll('.songCheckbox:checked');
    var songIdsToDelete = [];

    selectedSongs.forEach(function(checkbox) {
      var songId = checkbox.value;
      songIdsToDelete.push(songId);
      var songRow = checkbox.closest('tr');
      songRow.classList.add('deleted-song');  // 곡을 연하게 표시
    });

    // 삭제된 곡들을 서버로 전송
    var form = document.getElementById('songDeleteForm');
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'deleteSongIds';
    input.value = songIdsToDelete.join(',');
    form.appendChild(input);

    // 폼 제출
    form.submit();
  }
</script>

</body>
</html>